package com.foxconn.sw.data.mapper.extension.oa;

import com.foxconn.sw.data.dto.entity.task.BriefTaskVo;
import com.foxconn.sw.data.dto.entity.task.TaskParams;
import com.foxconn.sw.data.entity.SwTask;
import com.foxconn.sw.data.mapper.auto.SwTaskMapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Result;
import org.apache.ibatis.annotations.Results;
import org.apache.ibatis.annotations.Select;
import org.apache.ibatis.type.JdbcType;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface SwTaskExtensionMapper extends SwTaskMapper {


    @Select({"<script>",
            "SELECT st.*",
            "FROM sw_task st",
            "         JOIN sw_task_employee_relation ste ON st.id = ste.task_id and ste.is_delete=0",
            "<where>",
            "(st.parent_id = 0 OR (st.parent_id > 0",
            "    AND NOT EXISTS(SELECT 1",
            "                   FROM sw_task_employee_relation strep",
            "                            JOIN sw_task stp ON strep.task_id = stp.id and strep.is_delete=0",
            "                   WHERE stp.id = st.parent_id",
            "and strep.employee_no in ",
            "<foreach collection='employeeNos' open='(' close=')' separator=',' item='employeeNo'>",
            " #{employeeNo} ",
            "</foreach>",
            ")))",
            "and ste.employee_no in ",
            "<foreach collection='employeeNos' open='(' close=')' separator=',' item='employeeNo'>",
            " #{employeeNo} ",
            "</foreach>",
            "<if test='params.keyWord!=null and params.keyWord!=\"\"' >",
            " and title like CONCAT('%', #{params.keyWord,jdbcType=VARCHAR}, '%') ",
            "</if> ",
            "<if test='params.taskNo!=null and params.taskNo!=\"\"' >",
            " and task_no=#{params.taskNo}",
            "</if> ",
            "<if test='params.title!=null and params.title!=\"\"' >",
            " and title like CONCAT('%', #{params.title,jdbcType=VARCHAR}, '%') ",
            "</if> ",
            "<if test='params.proposer!=null and params.proposer!=\"\"' >",
            " and proposer_eid=#{params.proposer,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.hasCollaborate==null || !params.hasCollaborate' >",
            " and category!='6-2'",
            "</if> ",
            "<if test='params.project!=null and params.project!=\"\"' >",
            " and project=#{params.project,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.category!=null and params.category!=\"\"' >",
            " and category=#{params.category,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.create_s!=null and params.create_s!=\"\"' >",
            " and st.create_time &gt;= #{params.create_s,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.create_e!=null and params.create_e!=\"\"' >",
            " and st.create_time &lt;= #{params.create_e,jdbcType=VARCHAR}",
            "</if> ",

            "<if test='params.deadline_s!=null and params.deadline_s!=\"\"' >",
            " and st.dead_line &gt;= #{params.deadline_s,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.deadline_e!=null and params.deadline_e!=\"\"' >",
            " and st.dead_line &lt;= #{params.deadline_e,jdbcType=VARCHAR}",
            "</if> ",

            "<if test='proposer!=null and proposer!=\"\"' >",
            " and ((st.proposer_eid = #{proposer,jdbcType=VARCHAR} and st.status in (0,1,2,3,4,6,7)) or st.status in (1,2,3,4,6,7))",
            "</if> ",

            "<if test='params.handler!=null and params.handler!=\"\"' >",
            " and ste.employee_no = #{params.handler,jdbcType=VARCHAR} and ste.role_flag&amp;2=2 and ste.role_flag&amp;4=4",
            "</if> ",

            "<if test='params.statusList!=null and params.statusList.size()>0'>",
            "and st.status in",
            "<foreach collection='params.statusList' item='status' open='(' separator=',' close=')'>",
            "#{status,jdbcType=INTEGER}",
            "</foreach>",
            "</if> ",

            "<if test='params.viewType==1'>",
            " and ste.employee_no=#{proposer,jdbcType=VARCHAR} and ste.role_flag&amp;7> 0",
            "</if> ",
            "<if test='params.viewType==2'>",
            " and ste.employee_no=#{proposer,jdbcType=VARCHAR} and ste.role_flag&amp;1= 0 and ste.role_flag&amp;2= 0 and ste.role_flag&amp;4= 0 AND ste.role_flag&amp;8= 8",
            "</if> ",

            "<if test='params.searchType==1'  >",
            " and st.status=1 ",
            "</if> ",
            "<if test='params.searchType==2'  >",
            " and (st.status=2 or (st.status=3 and ste.is_inspector=0)) ",
            "</if> ",
            "<if test='params.searchType==3'  >",
            " and st.status=3 and ste.is_inspector=1 ",
            "</if> ",
            "<if test='params.searchType==4'  >",
            " and st.status in (1,2) and dead_line &lt;#{nowDate,jdbcType=VARCHAR} ",
            "</if> ",
            "</where>",

            "<choose>",
            "<when test='params.orderBy!=null'>",
            "ORDER BY #{params.orderBy.field,jdbcType=VARCHAR} ",
            "<if test='params.orderBy.order==\"descend\"'  >",
            " desc ",
            "</if> ",
            "</when>",
            "<otherwise>",
            "ORDER BY id desc",
            "</otherwise>",
            "</choose>",

            "LIMIT #{start,jdbcType=INTEGER} , #{end,jdbcType=INTEGER} ",
            "</script>"
    })
    @Results({
            @Result(column = "id", property = "id", jdbcType = JdbcType.INTEGER, id = true),
            @Result(column = "task_no", property = "taskNo", jdbcType = JdbcType.BIGINT),
            @Result(column = "top_category", property = "topCategory", jdbcType = JdbcType.VARCHAR),
            @Result(column = "category", property = "category", jdbcType = JdbcType.VARCHAR),
            @Result(column = "title", property = "title", jdbcType = JdbcType.VARCHAR),
            @Result(column = "top_project", property = "topProject", jdbcType = JdbcType.VARCHAR),
            @Result(column = "project", property = "project", jdbcType = JdbcType.VARCHAR),
            @Result(column = "level", property = "level", jdbcType = JdbcType.VARCHAR),
            @Result(column = "progress_percent", property = "progressPercent", jdbcType = JdbcType.INTEGER),
            @Result(column = "status", property = "status", jdbcType = JdbcType.INTEGER),
            @Result(column = "reject_status", property = "rejectStatus", jdbcType = JdbcType.INTEGER),
            @Result(column = "proposer_eid", property = "proposerEid", jdbcType = JdbcType.VARCHAR),
            @Result(column = "manager_eid", property = "managerEid", jdbcType = JdbcType.VARCHAR),
            @Result(column = "handle_eid", property = "handleEid", jdbcType = JdbcType.VARCHAR),
            @Result(column = "dead_line", property = "deadLine", jdbcType = JdbcType.VARCHAR),
            @Result(column = "reflection", property = "reflection", jdbcType = JdbcType.VARCHAR),
            @Result(column = "create_time", property = "createTime", jdbcType = JdbcType.TIMESTAMP),
            @Result(column = "datetime_lastchange", property = "datetimeLastchange", jdbcType = JdbcType.TIMESTAMP),
            @Result(column = "description", property = "description", jdbcType = JdbcType.LONGVARCHAR)
    })
    List<SwTask> listBriefVos(@Param("start") int start,
                              @Param("end") int end,
                              @Param("params") TaskParams params,
                              @Param("employeeNos") List<String> employeeNos,
                              @Param("nowDate") String nowDate,
                              @Param("proposer") String proposer);

    @Select({"<script>",
            "SELECT st.*",
            "FROM sw_task st",
            "         JOIN sw_task_employee_relation ste ON st.id = ste.task_id and ste.is_delete=0",
            "<where>",
            "(st.parent_id = 0 OR (st.parent_id > 0",
            "    AND NOT EXISTS(SELECT 1",
            "                   FROM sw_task_employee_relation strep",
            "                            JOIN sw_task stp ON strep.task_id = stp.id and strep.is_delete=0",
            "                   WHERE stp.id = st.parent_id",
            "and strep.employee_no in ",
            "<foreach collection='employeeNos' open='(' close=')' separator=',' item='employeeNo'>",
            " #{employeeNo} ",
            "</foreach>",
            ")))",
            "and ste.employee_no in ",
            "<foreach collection='employeeNos' open='(' close=')' separator=',' item='employeeNo'>",
            " #{employeeNo} ",
            "</foreach>",
            "<if test='params.keyWord!=null and params.keyWord!=\"\"' >",
            " and title like CONCAT('%', #{params.keyWord,jdbcType=VARCHAR}, '%') ",
            "</if> ",
            "<if test='params.taskNo!=null and params.taskNo!=\"\"' >",
            " and task_no=#{params.taskNo}",
            "</if> ",
            "<if test='params.title!=null and params.title!=\"\"' >",
            " and title like CONCAT('%', #{params.title,jdbcType=VARCHAR}, '%') ",
            "</if> ",
            "<if test='params.proposer!=null and params.proposer!=\"\"' >",
            " and proposer_eid=#{params.proposer,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.project!=null and params.project!=\"\"' >",
            " and project=#{params.project,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.category!=null and params.category!=\"\"' >",
            " and category=#{params.category,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.create_s!=null and params.create_s!=\"\"' >",
            " and st.create_time &gt;= #{params.create_s,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.create_e!=null and params.create_e!=\"\"' >",
            " and st.create_time &lt;= #{params.create_e,jdbcType=VARCHAR}",
            "</if> ",

            "<if test='params.deadline_s!=null and params.deadline_s!=\"\"' >",
            " and st.dead_line &gt;= #{params.deadline_s,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.deadline_e!=null and params.deadline_e!=\"\"' >",
            " and st.dead_line &lt;= #{params.deadline_e,jdbcType=VARCHAR}",
            "</if> ",

            "<if test='proposer!=null and proposer!=\"\"' >",
            " and ((st.proposer_eid = #{proposer,jdbcType=VARCHAR} and st.status in (0,1,2,3,4,6,7)) or st.status in (1,2,3,4,6,7))",
            "</if> ",

            "<if test='params.handler!=null and params.handler!=\"\"' >",
            " and ste.employee_no = #{params.handler,jdbcType=VARCHAR} and ste.role_flag&amp;2=2 and ste.role_flag&amp;4=4",
            "</if> ",
            "<if test='params.hasCollaborate==null || !params.hasCollaborate' >",
            " and category!='6-2'",
            "</if> ",

            "<if test='params.statusList!=null and params.statusList.size()>0'>",
            "and st.status in",
            "<foreach collection='params.statusList' item='status' open='(' separator=',' close=')'>",
            "#{status,jdbcType=INTEGER}",
            "</foreach>",
            "</if> ",

            "<if test='params.viewType==1'>",
            " and ste.employee_no=#{proposer,jdbcType=VARCHAR} and ste.role_flag&amp;7> 0",
            "</if> ",
            "<if test='params.viewType==2'>",
            " and ste.employee_no=#{proposer,jdbcType=VARCHAR} and ste.role_flag&amp;1= 0 and ste.role_flag&amp;2= 0 and ste.role_flag&amp;4= 0 AND ste.role_flag&amp;8= 8",
            "</if> ",

            "<if test='params.searchType==1'  >",
            " and st.status=1 ",
            "</if> ",
            "<if test='params.searchType==2'  >",
            " and (st.status=2 or (st.status=3 and ste.is_inspector=0)) ",
            "</if> ",
            "<if test='params.searchType==3'  >",
            " and st.status=3 and ste.is_inspector=1 ",
            "</if> ",
            "<if test='params.searchType==4'  >",
            " and st.status in (1,2) and dead_line &lt;#{nowDate,jdbcType=VARCHAR} ",
            "</if> ",
            "</where>",
            "</script>"
    })
    @Results({
            @Result(column = "category", property = "category", jdbcType = JdbcType.VARCHAR),
            @Result(column = "project", property = "project", jdbcType = JdbcType.VARCHAR),
            @Result(column = "status", property = "status", jdbcType = JdbcType.INTEGER),
            @Result(column = "reject_status", property = "rejectStatus", jdbcType = JdbcType.INTEGER),
            @Result(column = "proposer_eid", property = "proposerEid", jdbcType = JdbcType.VARCHAR),
    })
    List<SwTask> listProjectFilter(@Param("params") TaskParams params,
                                   @Param("employeeNos") List<String> employeeNos,
                                   @Param("nowDate") String nowDate,
                                   @Param("proposer") String proposer);


    @Select({"<script>",
            "SELECT st.*",
            "FROM sw_task st",
            "         JOIN sw_task_employee_relation ste ON st.id = ste.task_id and ste.is_delete=0",
            "<where>",
            "(st.parent_id = 0 OR (st.parent_id > 0",
            "    AND NOT EXISTS(SELECT 1",
            "                   FROM sw_task_employee_relation strep",
            "                            JOIN sw_task stp ON strep.task_id = stp.id and strep.is_delete=0",
            "                   WHERE stp.id = st.parent_id",
            "and strep.employee_no in ",
            "<foreach collection='employeeNos' open='(' close=')' separator=',' item='employeeNo'>",
            " #{employeeNo} ",
            "</foreach>",
            ")))",
            "and ste.employee_no in ",
            "<foreach collection='employeeNos' open='(' close=')' separator=',' item='employeeNo'>",
            " #{employeeNo} ",
            "</foreach>",
            "<if test='params.keyWord!=null and params.keyWord!=\"\"' >",
            " and title like CONCAT('%', #{params.keyWord,jdbcType=VARCHAR}, '%') ",
            "</if> ",
            "<if test='params.taskNo!=null and params.taskNo!=\"\"' >",
            " and task_no=#{params.taskNo}",
            "</if> ",
            "<if test='params.title!=null and params.title!=\"\"' >",
            " and title like CONCAT('%', #{params.title,jdbcType=VARCHAR}, '%') ",
            "</if> ",
            "<if test='params.proposer!=null and params.proposer!=\"\"' >",
            " and proposer_eid=#{params.proposer,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.project!=null and params.project!=\"\"' >",
            " and project=#{params.project,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.category!=null and params.category!=\"\"' >",
            " and category=#{params.category,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.create_s!=null and params.create_s!=\"\"' >",
            " and st.create_time &gt;= #{params.create_s,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.create_e!=null and params.create_e!=\"\"' >",
            " and st.create_time &lt;= #{params.create_e,jdbcType=VARCHAR}",
            "</if> ",

            "<if test='params.deadline_s!=null and params.deadline_s!=\"\"' >",
            " and st.dead_line &gt;= #{params.deadline_s,jdbcType=VARCHAR}",
            "</if> ",
            "<if test='params.deadline_e!=null and params.deadline_e!=\"\"' >",
            " and st.dead_line &lt;= #{params.deadline_e,jdbcType=VARCHAR}",
            "</if> ",

            "<if test='proposer!=null and proposer!=\"\"' >",
            " and ((st.proposer_eid = #{proposer,jdbcType=VARCHAR} and st.status in (0,1,2,3,4,6,7)) or st.status in (1,2,3,4,6,7))",
            "</if> ",

            "<if test='params.handler!=null and params.handler!=\"\"' >",
            " and ste.employee_no = #{params.handler,jdbcType=VARCHAR} and ste.role_flag&amp;2=2 and ste.role_flag&amp;4=4",
            "</if> ",

            "<if test='params.statusList!=null and params.statusList.size()>0'>",
            "and st.status in",
            "<foreach collection='params.statusList' item='status' open='(' separator=',' close=')'>",
            "#{status,jdbcType=INTEGER}",
            "</foreach>",
            "</if> ",
            "<if test='params.hasCollaborate==null || !params.hasCollaborate' >",
            " and category!='6-2'",
            "</if> ",
            "<if test='params.viewType==1'>",
            " and ste.employee_no=#{proposer,jdbcType=VARCHAR} and ste.role_flag&amp;7> 0",
            "</if> ",
            "<if test='params.viewType==2'>",
            " and ste.employee_no=#{proposer,jdbcType=VARCHAR} and ste.role_flag&amp;1= 0 and ste.role_flag&amp;2= 0 and ste.role_flag&amp;4= 0 AND ste.role_flag&amp;8= 8",
            "</if> ",

            "<if test='params.searchType==1'  >",
            " and st.status=1 ",
            "</if> ",
            "<if test='params.searchType==2'  >",
            " and (st.status=2 or (st.status=3 and ste.is_inspector=0)) ",
            "</if> ",
            "<if test='params.searchType==3'  >",
            " and st.status=3 and ste.is_inspector=1 ",
            "</if> ",
            "<if test='params.searchType==4'  >",
            " and st.status in (1,2) and dead_line &lt;#{nowDate,jdbcType=VARCHAR} ",
            "</if> ",
            "</where>",
            "ORDER BY st.id ",
            "</script>"
    })
    Long getTotalCountByParams(@Param("params") TaskParams params,
                               @Param("employeeNos") List<String> employeeNos,
                               @Param("nowDate") String nowDate,
                               @Param("proposer") String proposer);

    @Select({
            "select * ",
            "from sw_task",
            "where id = #{id,jdbcType=INTEGER}"
    })
    @Results({
            @Result(column = "id", property = "id", jdbcType = JdbcType.INTEGER, id = true),
            @Result(column = "task_no", property = "taskNo", jdbcType = JdbcType.BIGINT),
            @Result(column = "top_category", property = "topCategory", jdbcType = JdbcType.VARCHAR),
            @Result(column = "category", property = "category", jdbcType = JdbcType.VARCHAR),
            @Result(column = "title", property = "title", jdbcType = JdbcType.VARCHAR),
            @Result(column = "top_project", property = "topProject", jdbcType = JdbcType.VARCHAR),
            @Result(column = "project", property = "project", jdbcType = JdbcType.VARCHAR),
            @Result(column = "level", property = "level", jdbcType = JdbcType.VARCHAR),
            @Result(column = "progress_percent", property = "progressPercent", jdbcType = JdbcType.INTEGER),
            @Result(column = "status", property = "status", jdbcType = JdbcType.INTEGER),
            @Result(column = "reject_status", property = "rejectStatus", jdbcType = JdbcType.INTEGER),
            @Result(column = "proposer_eid", property = "proposerEid", jdbcType = JdbcType.VARCHAR),
            @Result(column = "manager_eid", property = "managerEid", jdbcType = JdbcType.VARCHAR),
            @Result(column = "handle_eid", property = "handleEid", jdbcType = JdbcType.VARCHAR),
            @Result(column = "dead_line", property = "deadLine", jdbcType = JdbcType.VARCHAR),
            @Result(column = "reflection", property = "reflection", jdbcType = JdbcType.VARCHAR),
            @Result(column = "create_time", property = "createTime", jdbcType = JdbcType.TIMESTAMP),
            @Result(column = "datetime_lastchange", property = "datetimeLastchange", jdbcType = JdbcType.TIMESTAMP),
            @Result(column = "description", property = "description", jdbcType = JdbcType.LONGVARCHAR)
    })
    BriefTaskVo selectByTaskId(Integer id);


    @Select({"<script>",
            "select count(1) ",
            "from sw_task s",
            "     inner join sw_task_employee_relation e on s.id = e.task_id",
            "where e.employee_no = #{employeeNo,jdbcType=VARCHAR} ",
            "  and ((s.status in (1, 2) and e.role_flag &amp; 4 = 4) ",
            "    or (s.status = 3 and e.role_flag &amp; 1 = 1) ",
            "    or (s.status = 3 and e.role_flag &amp; 2 = 2))",
            "</script>"})
    Integer getTaskCount(String employeeNo);

    @Select({"<script>",
            "select count(1) ",
            "from sw_task s",
            "     inner join sw_task_employee_relation e on s.id = e.task_id",
            "where e.employee_no = #{employeeNo,jdbcType=VARCHAR} ",
            "  and e.is_read = 0 ",
            "  and ((s.status in (1, 2) and e.role_flag &amp; 4 = 4) ",
            "    or (s.status = 3 and e.role_flag &amp; 1 = 1) ",
            "    or (s.status = 3 and e.role_flag &amp; 2 = 2))",
            "</script>"})
    Integer getUnReadTaskCount(String employeeNo);

    @Select({"<script>",
            "select count(1) ",
            "from sw_task s",
            "     inner join sw_task_employee_relation e on s.id = e.task_id",
            "where e.employee_no = #{employeeNo,jdbcType=VARCHAR} ",
            "  and s.category = '6-2' ",
            "  and s.status in (1, 2, 3, 4) ",
            "  and e.is_delete = 0 ",
            "</script>"})
    Integer getCollaborationCount(String employeeNo);
}
